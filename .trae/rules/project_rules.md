# 项目开发工作流程

## 工作流程规范

### 提交和推送流程
**每次代码提交后必须执行以下步骤：**

1. **更新相关文档**：
   - 如果修复了错误，更新 `docs/DEVELOPMENT-ERRORS.md`
   - 如果添加了新的开发规则，更新 `.trae/project-rules.md`
   - 如果有架构或功能变更，更新 `docs/PROJECT-CONTEXT.md`

2. **提交所有更改**：
   ```bash
   git add .
   git commit -m "提交信息"
   ```

3. **自动推送到远程仓库**：
   ```bash
   git push
   ```

4. **远端环境准备提醒**：
   - ⚠️ **重要**: 如果需要在远端机器运行，请确保已准备以下环境：
     - 安装Az PowerShell模块：`Install-Module -Name Az -Scope CurrentUser -Force`
     - 安装System.Data.SQLite：运行 `.\scripts\install-sqlite-dll.ps1`
     - 检查目录权限：运行 `.\scripts\check-environment.ps1`
     - 登录Azure：`Connect-AzAccount -UseDeviceAuthentication`
   - 详细说明请参考：`docs/REMOTE-ENVIRONMENT.md`

**重要**：不要遗漏任何文档更新，确保代码和文档同步。

---

## 代码审查检查清单

### 9.1 环境配置
- [ ] 检查是否需要安装依赖工具（如gh CLI）
- [ ] 检查环境变量配置是否正确
- [ ] 检查远程仓库是否存在

### 9.2 编码规范
- [ ] 所有PowerShell脚本使用UTF-8 BOM编码
- [ ] 检查文件编码一致性
- [ ] 检查Git配置（core.autocrlf, core.eol）
- [ ] 检查.editorconfig配置

### 9.3 模块管理
- [ ] 检查模块检测机制是否健壮
- [ ] 检查模块导入路径是否正确
- [ ] 检查模块版本兼容性
- [ ] 检查所有公共函数是否已导出

### 9.4 参数类型
- [ ] 检查参数类型定义是否合理
- [ ] 检查参数验证是否充分
- [ ] 检查参数默认值是否合理
- [ ] 检查是否使用了PowerShell内置参数名称

### 9.5 Azure命令
- [ ] 检查Azure命令参数是否完整
- [ ] 检查ASR命令是否先导入Vault上下文
- [ ] 检查Backup命令是否指定ContainerType和WorkloadType
- [ ] 检查命令文档是否正确

### 9.6 数据库操作
- [ ] 检查数据库连接生命周期是否明确
- [ ] 检查数据库查询是否正确处理DBNull
- [ ] 检查数据库操作前是否检查连接状态
- [ ] 检查是否使用缓存机制

### 9.7 CSV导出
- [ ] 检查是否使用Export-Csv而不是Export-Excel
- [ ] 检查Export-Csv是否使用UTF8BOM编码
- [ ] 检查是否避免了外部依赖

### 9.8 错误处理
- [ ] 检查try-catch块是否完整
- [ ] 检查错误日志是否详细
- [ ] 检查错误恢复机制是否健全
- [ ] 检查重试机制是否合理

### 9.9 性能优化
- [ ] 检查是否有不必要的重复操作
- [ ] 检查是否有长时间运行的阻塞操作
- [ ] 检查是否使用了缓存机制
- [ ] 检查是否支持并发执行

### 9.10 安全性
- [ ] 检查敏感信息是否泄露
- [ ] 检查认证信息是否安全存储
- [ ] 检查权限控制是否合理

### 9.11 文档完整性
- [ ] 检查README是否更新
- [ ] 检查注释是否清晰
- [ ] 检查参数说明是否完整
- [ ] 检查使用示例是否正确
- [ ] 检查错误文档是否更新

---

## 常见错误模式

### 10.1 参数类型过窄
**症状**: 类型转换错误  
**原因**: 参数类型定义过于具体  
**解决**: 使用更宽泛的类型（如`[object]`、`[psobject]`）

### 10.2 未导出公共函数
**症状**: 函数调用失败  
**原因**: 未在Export-ModuleMember中声明  
**解决**: 检查并添加所有公共函数到导出列表

### 10.3 编码不一致
**症状**: 中文显示乱码或语法错误  
**原因**: 文件编码不统一  
**解决**: 统一使用UTF-8 BOM编码

### 10.4 缺少错误处理
**症状**: 脚本意外终止  
**原因**: 未使用try-catch块  
**解决**: 在关键操作周围添加错误处理

### 10.5 不必要的用户交互
**症状**: 自动化场景需要手动确认  
**原因**: 未考虑自动化需求  
**解决**: 提供配置选项控制交互行为

### 10.6 数据库连接未打开
**症状**: "数据库连接未打开"错误  
**原因**: 未在操作前初始化数据库连接  
**解决**: 在所有数据库操作前检查连接状态

### 10.7 Azure命令参数缺失
**症状**: 命令提示缺少参数  
**原因**: 未提供必需的参数  
**解决**: 查看命令文档，添加所有必需参数

### 10.8 DateTime解析错误
**症状**: "String was not recognized as a valid DateTime"错误  
**原因**: 直接对DBNull值调用DateTime.Parse  
**解决**: 先保存到变量，检查是否为DBNull再解析

---

## 提交前检查

### 11.1 运行检查脚本
```powershell
# 在提交前运行检查
.\scripts\pre-commit-check.ps1
```

### 11.2 检查内容
- 文件编码检查（UTF-8 BOM）
- 语法错误检查
- 模块导出检查
- 敏感信息检查

---

## 文档更新

### 12.1 错误文档
- 每次遇到新错误时，更新`docs/DEVELOPMENT-ERRORS.md`
- 记录错误信息、发生场景、根本原因、修正方案、预防措施
- 更新版本历史

### 12.2 项目规则
- 本文档定义项目的开发规则和审查标准
- 在代码审查时参考本文档
- 规则变更时更新版本历史

### 12.3 README文档
- 每次添加新功能时，更新README
- 说明功能使用方法
- 提供配置示例

---

## 版本历史

| 版本 | 日期 | 变更说明 | 作者 |
|------|------|---------|------|
| 1.0.0 | 2026-01-28 | 初始版本，定义项目开发工作流程 | Azure DR Team |

---

## 联系信息

如有问题或建议，请联系：
- **项目团队**: Azure DR Team
- **文档位置**: `d:\UserProfiles\JoeHe\Codes\Azure-DR-Drill-Automation-Trae\.trae\`

---

**文档最后更新**: 2026-01-28
