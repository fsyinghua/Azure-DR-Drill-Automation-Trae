# Azure Site Recovery DR 演练自动化脚本开发需求文档

## 1. 项目概述

### 1.1 项目背景
本项目的目标是开发一套 Azure Site Recovery (ASR) 灾难恢复演练自动化脚本，用于自动化执行从香港（EA）到新加坡（SEA）的虚拟机 DR 演练流程。当前已有 17 台虚拟机配置了 ASR 复制，需要实现完整的故障转移测试流程。

### 1.2 项目目标
- 实现安全的、可控制的 ASR 测试故障转移自动化
- 支持单台虚拟机到多台虚拟机的 DR 演练
- 解决 CloudShell 会话超时问题，确保长时间任务可靠执行
- 提供灵活的执行策略和详细的日志记录
- 最小化生产环境影响，确保操作可逆
- 支持多订阅自动发现与 VM 名称自动定位订阅/资源组

### 1.3 设计原则
- **状态与进度持久化优先**: 优先使用 SQLite 作为状态/作业/进度的持久化存储（替代单纯 JSON 文件），确保 CloudShell 会话中断后可恢复
- **减少长循环阻塞**: 尽量减少使用逐台串行的 `foreach` 长循环；如需遍历，优先采用可控并发的队列/批处理方式
- **并发优先**: 在 Azure 与脚本资源允许的前提下，尽量使用多并发处理（按 VM 或按作业粒度），通过限流控制并发上限
- **通知即时且可聚合**: 每台虚拟机完成某项任务后立即发送该虚拟机的阶段完成通知；同时通知需包含总体进度（完成/总数、失败/重试、当前阶段等）
- **可观测性**: 日志、作业状态、进度统计应统一落库并可按 VM/阶段/时间查询

### 1.4 最小配置要求

在启用多订阅自动发现与 VM 上下文自动解析后，用户仅需配置以下必要项即可运行：

#### 必需配置项
- **源/目标区域**（regions.source / regions.target）
- **测试网络配置**（network.testVirtualNetworkName / testSubnetName）
- **SQLite 持久化路径**（persistence.databasePath）
- **通知渠道**（如启用则需提供 Teams Webhook 或 SMTP 信息）

#### 可选配置项（有默认值）
以下配置项在自动发现模式下为**可选项**，主要用于加速扫描或解决冲突：
- **订阅过滤**（discovery.subscriptions.allowList / denyList）
- **默认订阅/Vault/RG**（defaults 节点，仅当需要加速或冲突兜底时填写）
- **缓存 TTL**（discovery.cache.ttlMinutes，默认 24 小时）
- **执行策略**（execution 节点，有默认值：超时、重试、并发上限、轮询间隔）
- **进度通知节流/汇总频率**（progress 节点，有默认值）

> **设计目标**：用户复制 `AzureConfig.example.json` 后，仅需修改 3-4 项即可运行，其余保持默认即可。

## 2. 系统环境

### 2.1 Azure 环境
- **源区域**: East Asia (香港)
- **目标区域**: Southeast Asia (新加坡)
- **服务**: Azure Site Recovery (Recovery Services Vault)
- **权限级别**: Contributor（无法为 Runbook 分配 RBAC 权限）
- **多订阅支持**: 脚本需自动枚举当前账号可访问的所有订阅，发现订阅内的 ASR 配置，并基于虚拟机名称自动定位所需的订阅、Recovery Services Vault 和资源组
- **输入方式**:
  - 用户后续仅提供虚拟机名称（或虚拟机名称列表），脚本自动判断所需订阅/资源组/保管库上下文

### 2.2 虚拟机列表
需要处理的 17 台虚拟机（排除 2 台灰色高亮虚拟机）:
- DMS15SSEGHK (GFD - Application server)
- DMSP06UATDHHK (GFD - SharePoint System)
- GLD02SSDHHK (GLD - Domain Name Server)
- GLD02SSEGHK (GLD - Domain Name Server)
- GLDAPP01VMP (GLD - Intranet Server)
- GSDAPP01VMP (GSD - GSD System, SQL Server)
- GSDAPP02VMT (GSD - GSD System, SQL Server)
- GSDCSADB01VMP (GSD - CSA Expert SQL Server)
- INFGAL01VMP (GIT - NETsec GALsync)
- INFMID02VMP (GIT - Create user account)
- JFAP03VMD (JF - Jardine Foundation Application/DB Server)
- INFFPS01VMP (GIT - uniFLOW File & Print Server)
- UNF01VMP (GIT - uniFLOW Management Console)
- UNF02VMP (GIT - uniFLOW Print Server 21)
- UNF03VMP (GIT - uniFLOW Print Server 22)
- CA01SSEGHK
- DMS16SSEGHK
排除的虚拟机（灰色高亮）:
- INFTHY03VMP (GIT - Thycotic Primary)
- INFTHY04VMP (GIT - Thycotic Secondary)

## 3. 功能需求

### 3.1 核心功能模块

#### 3.1.1 测试故障转移模块
- 支持单台虚拟机的测试故障转移
- 支持指定恢复点类型（最新、应用一致、崩溃一致）
- 提供测试网络配置选项
- 支持测试完成后的自动清理

#### 3.1.2 完整 DR 演练模块
- 实现完整的 Failover → Commit → Reprotect → Failback → Commit → Reprotect 循环
- 支持分阶段执行（便于 CloudShell 操作）
- 支持单台、分批或全部虚拟机执行
- 提供暂停/继续功能

#### 3.1.3 监控与通知模块
- 执行状态实时监控
- 支持 Teams/邮件通知
- 详细的日志记录和报告生成
- 错误预警和重试机制
- 支持按 VM 粒度的阶段通知（每台 VM 完成当前阶段即通知）
- 通知内容需包含总体进度（已完成/总数、成功/失败/重试、当前阶段、预计剩余）

#### 3.1.4 配置管理模块
- 配置文件管理（订阅范围、缓存策略、默认行为）
- 虚拟机分组配置（按部门、重要性）
- 执行策略配置（超时、重试、并发）
- 订阅范围配置（AllowList/DenyList，可选）
- 资源发现与映射缓存配置（缓存路径/有效期/强制刷新）

#### 3.1.5 Azure 资源发现与映射模块
- 自动枚举当前账号可访问的所有订阅
- 自动发现订阅内的 Recovery Services Vault，并建立 ASR 作业上下文
- 自动获取受保护项目（Replication Protected Item）并按虚拟机名称建立映射（VMName -> Subscription/Vault/ResourceGroup/ProtectedItem）
- 支持映射缓存与过期策略，避免每次执行都全量扫描
- 支持当虚拟机名称在多个订阅/保管库同时存在时的冲突处理（提示并要求用户指定范围或优先级）

### 3.2 执行策略

#### 3.2.1 分阶段执行
1. **Phase 1**: Failover（故障转移）
2. **Phase 2**: Commit（提交）
3. **Phase 3**: Reprotect（重新保护）
4. **Phase 4**: Failback（故障恢复）
5. **Phase 5**: Commit（提交）
6. **Phase 6**: Reprotect（重新保护）

#### 3.2.2 分组执行策略
- **按部门分组**: GIT、GFD、GLD、GSD、JF
- **按重要性分组**: 关键、重要、一般
- **按批次分组**: 每批 2-3 台，控制执行时间

## 4. 技术实现

### 4.1 技术栈
- **脚本语言**: PowerShell 7.x
- **Azure 模块**: Az.RecoveryServices, Az.Compute, Az.Accounts
- **执行环境**: Azure CloudShell
- **存储**: SQLite（状态/进度/作业持久化），Azure Blob Storage（日志归档，可选）
- **通知**: Teams Webhook / Email

### 4.2 脚本架构

```
Azure-DR-Drill-Automation/
├── Config/
│   ├── AzureConfig.json        # Azure 配置（可选订阅范围/缓存策略）
│   ├── VMGroups.json          # 虚拟机分组配置
│   └── NotificationConfig.json # 通知配置
├── Scripts/
│   ├── Core/
│   │   ├── ASROperations.ps1   # ASR 基础操作函数
│   │   ├── Logger.ps1          # 日志记录函数
│   │   └── Notifier.ps1        # 通知函数
│   ├── Modules/
│   │   ├── TestFailover.ps1    # 测试故障转移模块
│   │   ├── FullDrill.ps1       # 完整演练模块
│   │   └── Cleanup.ps1         # 清理模块
│   └── Main/
│       ├── Test-DR-Simulation.ps1      # 模拟验证脚本
│       ├── Execute-TestFailover.ps1    # 测试故障转移执行
│       ├── Execute-FullDrill.ps1       # 完整演练执行
│       └── Monitor-DR-Jobs.ps1         # 作业监控
├── Templates/
│   ├── EmailTemplate.html      # 邮件模板
│   └── ReportTemplate.html     # 报告模板
└── Logs/                       # 日志目录
```

### 4.3 核心函数设计

#### 4.3.1 ASR 操作封装
```powershell
# 基础 ASR 操作类
class ASROperations {
    [string]$VaultName
    [string]$ResourceGroup
    [object]$VaultContext
    
    # 初始化
    ASROperations([string]$vaultName, [string]$resourceGroup) {
        $this.VaultName = $vaultName
        $this.ResourceGroup = $resourceGroup
        $this.InitializeVaultContext()
    }
    
    # 执行测试故障转移
    [object] InvokeTestFailover([string]$vmName, [hashtable]$options) {
        # 实现逻辑
    }
    
    # 执行完整 DR 演练
    [object] InvokeFullDrill([string]$vmName, [hashtable]$options) {
        # 实现逻辑
    }
    
    # 清理测试环境
    [object] CleanupTestFailover([string]$vmName) {
        # 实现逻辑
    }
}
```

#### 4.3.2 状态管理
```powershell
# 检查点管理器
class CheckpointManager {
    [string]$DatabasePath
    
    # 保存执行状态
    [void] SaveState([hashtable]$state) {
        # 将 state 持久化到 SQLite
    }
    
    # 加载执行状态
    [hashtable] LoadState() {
        # 从 SQLite 加载 state
        return @{}
    }
    
    # 恢复执行
    [void] ResumeExecution([string]$vmName, [string]$phase) {
        # 从检查点恢复
    }
}
```

#### 4.3.3 Azure 资源发现与映射
```powershell
# Azure 资源发现器
class AzureResourceDiscovery {
    [string[]]$SubscriptionAllowList
    [string[]]$SubscriptionDenyList
    [string]$MappingCacheFile
    [int]$CacheTtlMinutes

    # 枚举可访问订阅（可按 AllowList/DenyList 过滤）
    [object[]] GetAccessibleSubscriptions() {
        # 实现逻辑
    }

    # 发现订阅内的 Recovery Services Vault
    [object[]] DiscoverRecoveryServicesVaults([string]$subscriptionId) {
        # 实现逻辑
    }

    # 在指定 Vault 内枚举受保护项目，并建立 VMName 映射
    [hashtable] BuildProtectedItemMapping([object]$vault) {
        # 实现逻辑
    }

    # 基于 VMName 定位订阅/保管库/资源组/ProtectedItem
    [hashtable] ResolveVmContext([string]$vmName) {
        # 实现逻辑
    }
}
```

#### 4.3.4 进度与通知聚合
```powershell
# 进度聚合器（将 VM 粒度的阶段完成情况汇总成总体进度）
class ProgressAggregator {
    [string]$DatabasePath

    # 记录 VM 在某阶段的完成/失败/重试状态
    [void] RecordVmPhaseResult([string]$vmName, [string]$phase, [string]$status, [string]$jobId) {
        # 实现逻辑
    }

    # 获取总体进度快照（用于通知与报告）
    [hashtable] GetOverallProgress([string]$phase) {
        # 实现逻辑
    }
}
```

## 5. 开发计划

### 5.1 第一阶段：基础框架（Week 1-2）
- Azure 认证和配置管理
- 日志记录和错误处理框架
- 基础 ASR 操作封装
- 模拟验证脚本开发

### 5.2 第二阶段：测试故障转移（Week 3-4）
- 单台虚拟机测试故障转移
- 测试网络配置管理
- 自动清理机制
- 测试验证工具

### 5.3 第三阶段：完整演练（Week 5-6）
- 分阶段执行引擎
- 虚拟机分组和批次处理
- 状态管理和断点续传
- 通知和报告系统

### 5.4 第四阶段：优化和测试（Week 7-8）
- 性能优化和错误重试
- 完整测试套件
- 文档和使用手册
- 生产环境验证

## 6. 安全考虑

### 6.1 权限管理
- 使用 Contributor 权限级别
- 避免使用 Owner 权限需求
- 遵循最小权限原则
- 敏感信息加密存储
- 多订阅场景下需具备对目标订阅的读取与 ASR 操作权限；脚本启动时应自动检测可访问订阅并输出权限检查结果

### 6.2 操作安全
- 所有操作需要确认
- 支持 WhatIf 模拟模式
- 详细的预执行检查
- 可逆的操作设计

### 6.3 数据安全
- 不存储凭据信息
- 日志脱敏处理
- 传输数据加密
- 临时文件清理

## 7. 测试计划

### 7.1 单元测试
- ASR 操作函数测试
- 配置管理测试
- 错误处理测试
- 状态管理测试

### 7.2 集成测试
- 端到端流程测试
- 多虚拟机并发测试
- 长时间运行测试
- 异常场景测试

### 7.3 验收测试
- 单台虚拟机完整流程
- 分组虚拟机执行
- 实际 DR 演练验证
- 性能和生产环境测试

## 8. 部署和使用

### 8.1 环境准备
1. 安装 PowerShell 7.x
2. 安装 Azure PowerShell 模块
3. 配置 Azure 上下文（支持多订阅）
4. 验证当前账号对目标订阅具备读取与 ASR 操作权限
5. 设置通知渠道

### 8.2 配置步骤
```powershell
# 1. 克隆代码库
git clone <repository-url>

# 2. 配置环境
cd Azure-DR-Drill-Automation
Copy-Item Config\AzureConfig.example.json Config\AzureConfig.json

# 3. 编辑配置文件
# 修改 AzureConfig.json 中的订阅范围（可选）、缓存策略等信息

# 4. 执行模拟验证
.\Scripts\Main\Test-DR-Simulation.ps1 -WhatIf

# 5. 执行测试故障转移
.\Scripts\Main\Execute-TestFailover.ps1 -VMName "INFGAL01VMP"
```

### 8.3 常用命令
```powershell
# 模拟验证
.\Test-DR-Simulation.ps1 -WhatIf

# 单台测试故障转移
.\Execute-TestFailover.ps1 -VMName "INFGAL01VMP" -TestDurationMinutes 120

# 强制刷新资源发现与映射缓存（示例参数，具体以实现为准）
# .\Execute-TestFailover.ps1 -VMName "INFGAL01VMP" -RefreshDiscoveryCache

# 完整演练（分阶段）
.\Execute-FullDrill.ps1 -Phase Failover -VMFilter "GIT"
.\Execute-FullDrill.ps1 -Phase Commit -VMFilter "GIT"

# 批量执行
.\Execute-FullDrill.ps1 -BatchSize 3 -Phase FullCycle

# 清理测试环境
.\Cleanup-TestFailover.ps1 -VMName "INFGAL01VMP"
```

## 9. 附录

### 9.1 Azure PowerShell 命令参考

#### 资源发现相关命令
```powershell
# 获取所有订阅
Get-AzSubscription

# 切换订阅
Set-AzContext -SubscriptionId <subscription-id>

# 获取订阅内的 Recovery Services Vault
Get-AzRecoveryServicesVault

# 获取受保护项目（受保护项中可关联/映射到 VM）
Get-AzRecoveryServicesAsrReplicationProtectedItem
```

#### 测试故障转移相关命令
```powershell
# 获取受保护项目
Get-AzRecoveryServicesAsrReplicationProtectedItem

# 执行测试故障转移
Start-AzRecoveryServicesAsrTestFailoverJob

# 清理测试故障转移
Start-AzRecoveryServicesAsrTestFailoverCleanupJob

# 获取恢复点
Get-AzRecoveryServicesAsrRecoveryPoint
```

#### 完整 DR 演练相关命令
```powershell
# 故障转移
Start-AzRecoveryServicesAsrUnplannedFailoverJob

# 提交故障转移
Start-AzRecoveryServicesAsrCommitFailoverJob

# 重新保护
Start-AzRecoveryServicesAsrReprotectJob

# 监控作业
Get-AzRecoveryServicesAsrJob
Wait-ASRJob
```

### 9.2 错误代码和处理

| 错误代码 | 描述 | 处理建议 |
|---------|------|----------|
| ASR001 | 虚拟机未找到 | 检查虚拟机名称和复制状态 |
| ASR002 | 保管库访问失败 | 检查权限和网络连接 |
| ASR003 | 作业超时 | 增加超时时间或分批执行 |
| ASR004 | 网络配置错误 | 检查测试网络设置 |
| ASR005 | 恢复点不可用 | 等待复制完成或选择其他恢复点 |

### 9.3 性能指标

| 指标 | 目标值 | 说明 |
|------|--------|------|
| 单台虚拟机测试故障转移时间 | < 15分钟 | 包括启动和验证 |
| 单台虚拟机完整演练时间 | < 60分钟 | 6个阶段完整执行 |
| 并发处理能力 | 3-5台虚拟机 | 避免资源竞争 |
| 脚本执行超时时间 | 30分钟 | CloudShell 会话限制 |

### 9.4 联系方式和支持

- **项目负责人**: [He Joe]
- **技术联系人**: [He Joe]
- **业务联系人**: [HKT: Wong Ken/Ben Lee; JML: Tommy Hui/Andy Au Yuang]
- **紧急支持**: JSC Cloud Team

---

## 10. 更新日志

| 版本 | 日期 | 描述 | 作者 |
|------|------|------|------|
| v1.0 | 2024-01-20 | 初始需求文档 | [He Joe] |
| v1.1 | 2024-01-25 | 添加详细技术实现 | [He Joe] |
| v1.2 | 2024-01-30 | 更新测试计划和部署指南 | [He Joe] |

---

**注意事项**:
1. 本需求文档基于实际 Azure 环境设计，请在开发前验证所有配置
2. 生产环境部署前必须在测试环境充分验证
3. 所有操作都应遵守公司变更管理流程
4. 确保有完整的回滚计划

**下一步行动**:
1. 在测试环境验证基础框架
2. 开发测试故障转移模块
3. 进行单元测试和集成测试
4. 小范围生产环境试点
5. 全范围推广使用